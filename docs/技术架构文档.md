# 物品记录 App 技术架构文档

## 1. 项目概述

### 1.1 产品定位
一款帮助用户记录物品位置、减少忘带/找不到的 Flutter 跨端应用。

### 1.2 MVP 核心目标
- **10 秒内**完成一次物品位置记录（选物品 → 拍照即保存）
- **30 秒内**找到物品最后一次记录位置
- 轻提醒：不强迫、不计时、可忽略

### 1.3 技术栈选型

| 类别 | 技术选择 | 版本要求 |
|------|----------|----------|
| 框架 | Flutter | >= 3.16.0 |
| 语言 | Dart | >= 3.2.0 |
| 状态管理 | Riverpod | >= 2.4.0 |
| 路由 | GoRouter | >= 12.0.0 |
| 本地存储 | Hive | >= 2.2.0 |
| UI 风格 | Cupertino | Flutter 内置 |

---

## 2. 项目结构

```
lib/
├── app/                          # 应用层
│   ├── app.dart                  # CupertinoApp 入口配置
│   ├── router.dart               # GoRouter 路由表
│   └── theme.dart                # 主题配置（颜色、字体、间距）
│
├── core/                         # 核心工具层
│   ├── constants/
│   │   ├── app_constants.dart    # 应用常量
│   │   ├── storage_keys.dart     # Hive box 名称
│   │   └── asset_paths.dart      # 资源路径
│   ├── extensions/
│   │   ├── datetime_ext.dart     # DateTime 扩展
│   │   ├── string_ext.dart       # String 扩展
│   │   └── context_ext.dart      # BuildContext 扩展
│   ├── utils/
│   │   ├── date_formatter.dart   # 日期格式化工具
│   │   ├── image_utils.dart      # 图片处理工具
│   │   └── validators.dart       # 数据校验
│   └── errors/
│       └── app_exception.dart    # 自定义异常类
│
├── data/                         # 数据层
│   ├── local/
│   │   ├── hive_initializer.dart # Hive 初始化配置
│   │   └── adapters/             # Hive TypeAdapters
│   │       ├── item_adapter.dart
│   │       ├── record_adapter.dart
│   │       ├── scene_adapter.dart
│   │       └── intent_adapter.dart
│   └── repositories/             # Repository 实现
│       ├── item_repository_impl.dart
│       ├── record_repository_impl.dart
│       ├── scene_repository_impl.dart
│       └── intent_repository_impl.dart
│
├── domain/                       # 领域层
│   ├── models/                   # 数据模型（Freezed）
│   │   ├── item.dart             # 物品
│   │   ├── record.dart           # 记录
│   │   ├── scene.dart            # 场景
│   │   ├── intent.dart           # 意图
│   │   ├── location_info.dart    # 位置信息
│   │   └── enums/
│   │       ├── importance.dart   # 重要程度枚举
│   │       ├── category.dart     # 物品类别枚举
│   │       └── scene_type.dart   # 场景类型枚举
│   └── repositories/             # Repository 抽象接口
│       ├── item_repository.dart
│       ├── record_repository.dart
│       ├── scene_repository.dart
│       └── intent_repository.dart
│
├── features/                     # 功能模块层
│   ├── items/                    # 物品模块
│   │   ├── providers/
│   │   │   ├── items_provider.dart
│   │   │   └── item_detail_provider.dart
│   │   ├── screens/
│   │   │   ├── items_screen.dart
│   │   │   └── item_detail_screen.dart
│   │   └── widgets/
│   │       ├── item_card.dart
│   │       ├── item_list_tile.dart
│   │       └── item_search_bar.dart
│   │
│   ├── records/                  # 记录模块
│   │   ├── providers/
│   │   │   └── record_provider.dart
│   │   ├── screens/
│   │   │   ├── camera_screen.dart
│   │   │   └── record_complete_screen.dart
│   │   └── widgets/
│   │       ├── record_timeline.dart
│   │       └── record_card.dart
│   │
│   ├── scenes/                   # 场景模块
│   │   ├── providers/
│   │   │   └── scenes_provider.dart
│   │   ├── screens/
│   │   │   ├── scenes_screen.dart
│   │   │   └── scene_detail_screen.dart
│   │   └── widgets/
│   │       └── scene_card.dart
│   │
│   ├── retrieve/                 # 找回模块
│   │   ├── providers/
│   │   │   └── retrieve_provider.dart
│   │   ├── screens/
│   │   │   └── retrieve_screen.dart
│   │   └── widgets/
│   │       ├── record_viewer.dart
│   │       └── location_card.dart
│   │
│   ├── checkout/                 # 出门检查模块
│   │   ├── providers/
│   │   │   └── checkout_provider.dart
│   │   ├── screens/
│   │   │   └── checkout_screen.dart
│   │   └── widgets/
│   │       └── checklist_item.dart
│   │
│   ├── nudges/                   # 轻提醒模块
│   │   ├── providers/
│   │   │   ├── intents_provider.dart
│   │   │   └── nudge_provider.dart
│   │   ├── screens/
│   │   │   ├── nudges_screen.dart
│   │   │   └── intent_form_screen.dart
│   │   └── widgets/
│   │       ├── nudge_card.dart
│   │       └── intent_list_tile.dart
│   │
│   ├── settings/                 # 设置模块
│   │   ├── providers/
│   │   │   └── settings_provider.dart
│   │   ├── screens/
│   │   │   └── settings_screen.dart
│   │   └── widgets/
│   │       └── stats_card.dart
│   │
│   └── onboarding/               # 引导模块
│       ├── screens/
│       │   ├── welcome_screen.dart
│       │   ├── select_items_screen.dart
│       │   └── select_scenes_screen.dart
│       └── widgets/
│           └── onboarding_page.dart
│
├── services/                     # 服务层
│   ├── camera_service.dart       # 相机服务
│   ├── image_storage_service.dart # 图片存储服务
│   ├── location_service.dart     # 定位服务
│   ├── notification_service.dart # 通知服务
│   └── permission_service.dart   # 权限管理服务
│
├── shared/                       # 共享组件层
│   └── widgets/
│       ├── app_button.dart       # 通用按钮
│       ├── app_card.dart         # 通用卡片
│       ├── app_text_field.dart   # 通用输入框
│       ├── photo_viewer.dart     # 照片查看器
│       ├── empty_state.dart      # 空状态组件
│       ├── loading_overlay.dart  # 加载遮罩
│       └── bottom_tab_bar.dart   # 底部导航栏
│
└── main.dart                     # 应用入口
```

---

## 3. 数据模型设计

### 3.1 Item（物品）

```dart
@freezed
class Item with _$Item {
  const factory Item({
    required String id,           // UUID
    required String name,         // 物品名称
    required Category category,   // 类别（钥匙/证件/数码/其他）
    required Importance importance, // 重要程度（高/中/低）
    String? coverImagePath,       // 封面图路径（可选）
    String? iconName,             // 图标名称
    required DateTime createdAt,  // 创建时间
    required DateTime updatedAt,  // 更新时间
  }) = _Item;
}
```

### 3.2 Record（记录）

```dart
@freezed
class Record with _$Record {
  const factory Record({
    required String id,           // UUID
    required String itemId,       // 关联物品ID
    String? sceneId,              // 关联场景ID（可选）
    required String photoPath,    // 照片本地路径
    required DateTime timestamp,  // 记录时间
    LocationInfo? location,       // 位置信息（可选）
    String? note,                 // 备注（可选）
    @Default([]) List<String> tags, // 标签（玄关/抽屉/背包等）
  }) = _Record;
}
```

### 3.3 LocationInfo（位置信息）

```dart
@freezed
class LocationInfo with _$LocationInfo {
  const factory LocationInfo({
    required double latitude,     // 纬度
    required double longitude,    // 经度
    String? placeName,            // 地点名称（逆地理编码）
    String? address,              // 详细地址
  }) = _LocationInfo;
}
```

### 3.4 Scene（场景）

```dart
@freezed
class Scene with _$Scene {
  const factory Scene({
    required String id,           // UUID
    required String name,         // 场景名称
    required SceneType type,      // 场景类型
    required String iconName,     // 图标名称
    @Default([]) List<String> defaultItemIds, // 默认关联物品
    @Default(true) bool isActive, // 是否启用
    required int sortOrder,       // 排序顺序
  }) = _Scene;
}
```

### 3.5 Intent（意图）

```dart
@freezed
class Intent with _$Intent {
  const factory Intent({
    required String id,           // UUID
    required String title,        // 意图标题
    String? nextStep,             // 下一小步（可选）
    @Default([]) List<String> tags, // 标签（home/work/weekend/commute）
    @Default(false) bool isCompleted, // 是否已完成
    required DateTime createdAt,  // 创建时间
    required DateTime updatedAt,  // 更新时间
  }) = _Intent;
}
```

### 3.6 枚举类型

```dart
// 物品类别
enum Category {
  keys,       // 钥匙
  cards,      // 卡证
  digital,    // 数码
  documents,  // 证件文件
  daily,      // 日常用品
  other,      // 其他
}

// 重要程度
enum Importance {
  high,       // 高
  medium,     // 中
  low,        // 低
}

// 场景类型
enum SceneType {
  home,       // 回家
  office,     // 到公司
  parking,    // 下车停车
  travel,     // 旅行入住
  temporary,  // 临时收纳
  custom,     // 自定义
}
```

---

## 4. Repository 接口设计

### 4.1 ItemRepository

```dart
abstract class ItemRepository {
  // 查询
  Future<List<Item>> getAllItems();
  Future<Item?> getItemById(String id);
  Future<List<Item>> searchItems(String keyword);
  Future<List<Item>> getItemsByCategory(Category category);
  
  // 增删改
  Future<void> createItem(Item item);
  Future<void> updateItem(Item item);
  Future<void> deleteItem(String id);
  
  // 流式监听
  Stream<List<Item>> watchAllItems();
}
```

### 4.2 RecordRepository

```dart
abstract class RecordRepository {
  // 查询
  Future<List<Record>> getRecordsByItemId(String itemId);
  Future<Record?> getLatestRecordByItemId(String itemId);
  Future<List<Record>> getRecordsBySceneId(String sceneId);
  Future<List<Record>> getRecordsByDateRange(DateTime start, DateTime end);
  
  // 增删改
  Future<void> createRecord(Record record);
  Future<void> updateRecord(Record record);
  Future<void> deleteRecord(String id);
  
  // 统计
  Future<int> getRecordCountByItemId(String itemId);
  Future<int> getTotalRecordCount();
}
```

### 4.3 SceneRepository

```dart
abstract class SceneRepository {
  Future<List<Scene>> getAllScenes();
  Future<Scene?> getSceneById(String id);
  Future<void> createScene(Scene scene);
  Future<void> updateScene(Scene scene);
  Future<void> deleteScene(String id);
  Future<void> updateSceneItems(String sceneId, List<String> itemIds);
}
```

### 4.4 IntentRepository

```dart
abstract class IntentRepository {
  Future<List<Intent>> getAllIntents();
  Future<List<Intent>> getActiveIntents();
  Future<Intent?> getIntentById(String id);
  Future<void> createIntent(Intent intent);
  Future<void> updateIntent(Intent intent);
  Future<void> deleteIntent(String id);
  Future<void> markAsCompleted(String id);
  Future<Intent?> getRandomActiveIntent();
}
```

---

## 5. 服务层设计

### 5.1 CameraService

```dart
abstract class CameraService {
  /// 打开相机拍照
  Future<String?> takePhoto();
  
  /// 从相册选择
  Future<String?> pickFromGallery();
  
  /// 检查相机权限
  Future<bool> hasCameraPermission();
  
  /// 请求相机权限
  Future<bool> requestCameraPermission();
}
```

### 5.2 ImageStorageService

```dart
abstract class ImageStorageService {
  /// 保存图片到本地
  Future<String> saveImage(String sourcePath);
  
  /// 删除图片
  Future<void> deleteImage(String path);
  
  /// 获取图片存储目录
  Future<String> getImageDirectory();
  
  /// 压缩图片
  Future<String> compressImage(String sourcePath, {int quality = 80});
  
  /// 获取图片缩略图
  Future<String> getThumbnail(String sourcePath);
}
```

### 5.3 LocationService

```dart
abstract class LocationService {
  /// 获取当前位置
  Future<LocationInfo?> getCurrentLocation();
  
  /// 检查定位权限
  Future<bool> hasLocationPermission();
  
  /// 请求定位权限
  Future<bool> requestLocationPermission();
  
  /// 逆地理编码（坐标转地址）
  Future<String?> getAddressFromCoordinates(double lat, double lng);
  
  /// 打开地图导航
  Future<void> openInMaps(double lat, double lng, String? label);
}
```

### 5.4 NotificationService

```dart
abstract class NotificationService {
  /// 初始化通知
  Future<void> initialize();
  
  /// 检查通知权限
  Future<bool> hasNotificationPermission();
  
  /// 请求通知权限
  Future<bool> requestNotificationPermission();
  
  /// 调度轻提醒通知
  Future<void> scheduleNudgeNotification({
    required int id,
    required String title,
    required String body,
    required DateTime scheduledTime,
  });
  
  /// 取消指定通知
  Future<void> cancelNotification(int id);
  
  /// 取消所有通知
  Future<void> cancelAllNotifications();
}
```

### 5.5 PermissionService

```dart
abstract class PermissionService {
  /// 检查并请求相机权限
  Future<bool> ensureCameraPermission();
  
  /// 检查并请求定位权限
  Future<bool> ensureLocationPermission();
  
  /// 检查并请求通知权限
  Future<bool> ensureNotificationPermission();
  
  /// 打开应用设置页
  Future<void> openAppSettings();
}
```

---

## 6. 路由设计

### 6.1 路由表

| 路径 | 页面 | 说明 |
|------|------|------|
| `/` | MainScreen | 首页（底部 Tab 容器） |
| `/onboarding` | OnboardingFlow | 首次使用引导 |
| `/items` | ItemsScreen | 物品列表（Tab 1） |
| `/items/:id` | ItemDetailScreen | 物品详情 |
| `/items/:id/record` | CameraScreen | 记录拍照页 |
| `/items/:id/record/complete` | RecordCompleteScreen | 记录补全页 |
| `/items/:id/retrieve` | RetrieveScreen | 找回模式 |
| `/scenes` | ScenesScreen | 场景列表（Tab 2） |
| `/scenes/:id` | SceneDetailScreen | 场景详情（连续记录） |
| `/checkout` | CheckoutScreen | 出门检查 |
| `/nudges` | NudgesScreen | 顺手页（Tab 3） |
| `/nudges/new` | IntentFormScreen | 新增意图 |
| `/nudges/:id/edit` | IntentFormScreen | 编辑意图 |
| `/settings` | SettingsScreen | 设置页（Tab 4） |

### 6.2 路由配置结构

```dart
final goRouter = GoRouter(
  initialLocation: '/',
  redirect: (context, state) {
    // 检查是否首次使用，跳转引导页
    final isFirstLaunch = ref.read(isFirstLaunchProvider);
    if (isFirstLaunch && state.uri.path != '/onboarding') {
      return '/onboarding';
    }
    return null;
  },
  routes: [
    // 底部 Tab 导航
    StatefulShellRoute.indexedStack(
      builder: (context, state, navigationShell) {
        return MainScreen(navigationShell: navigationShell);
      },
      branches: [
        // Tab 1: 物品
        StatefulShellBranch(routes: [...]),
        // Tab 2: 场景
        StatefulShellBranch(routes: [...]),
        // Tab 3: 顺手
        StatefulShellBranch(routes: [...]),
        // Tab 4: 我的
        StatefulShellBranch(routes: [...]),
      ],
    ),
    // 引导页
    GoRoute(path: '/onboarding', ...),
  ],
);
```

---

## 7. Provider 设计

### 7.1 全局 Provider

```dart
// Repository Providers
final itemRepositoryProvider = Provider<ItemRepository>((ref) {
  return ItemRepositoryImpl(ref.read(hiveBoxProvider));
});

final recordRepositoryProvider = Provider<RecordRepository>((ref) {
  return RecordRepositoryImpl(ref.read(hiveBoxProvider));
});

// Service Providers
final cameraServiceProvider = Provider<CameraService>((ref) {
  return CameraServiceImpl();
});

final locationServiceProvider = Provider<LocationService>((ref) {
  return LocationServiceImpl();
});

final notificationServiceProvider = Provider<NotificationService>((ref) {
  return NotificationServiceImpl();
});
```

### 7.2 功能 Provider 示例

```dart
// 物品列表
@riverpod
Future<List<Item>> items(ItemsRef ref) async {
  final repository = ref.read(itemRepositoryProvider);
  return repository.getAllItems();
}

// 物品详情
@riverpod
Future<Item?> itemDetail(ItemDetailRef ref, String itemId) async {
  final repository = ref.read(itemRepositoryProvider);
  return repository.getItemById(itemId);
}

// 物品最新记录
@riverpod
Future<Record?> latestRecord(LatestRecordRef ref, String itemId) async {
  final repository = ref.read(recordRepositoryProvider);
  return repository.getLatestRecordByItemId(itemId);
}

// 物品记录时间线
@riverpod
Future<List<Record>> itemRecords(ItemRecordsRef ref, String itemId) async {
  final repository = ref.read(recordRepositoryProvider);
  return repository.getRecordsByItemId(itemId);
}
```

---

## 8. Hive 存储设计

### 8.1 Box 配置

| Box 名称 | 存储内容 | Key 类型 |
|----------|----------|----------|
| `items` | Item 对象 | String (id) |
| `records` | Record 对象 | String (id) |
| `scenes` | Scene 对象 | String (id) |
| `intents` | Intent 对象 | String (id) |
| `settings` | 用户设置 | String (key) |
| `nudgeHistory` | 提醒历史 | int (index) |

### 8.2 初始化流程

```dart
Future<void> initializeHive() async {
  // 1. 初始化 Hive
  await Hive.initFlutter();
  
  // 2. 注册 TypeAdapters
  Hive.registerAdapter(ItemAdapter());
  Hive.registerAdapter(RecordAdapter());
  Hive.registerAdapter(SceneAdapter());
  Hive.registerAdapter(IntentAdapter());
  Hive.registerAdapter(LocationInfoAdapter());
  Hive.registerAdapter(CategoryAdapter());
  Hive.registerAdapter(ImportanceAdapter());
  Hive.registerAdapter(SceneTypeAdapter());
  
  // 3. 打开 Boxes
  await Hive.openBox<Item>('items');
  await Hive.openBox<Record>('records');
  await Hive.openBox<Scene>('scenes');
  await Hive.openBox<Intent>('intents');
  await Hive.openBox('settings');
  await Hive.openBox<String>('nudgeHistory');
}
```

---

## 9. 主题设计

### 9.1 颜色体系

```dart
class AppColors {
  // 主色调
  static const primary = CupertinoColors.systemBlue;
  static const secondary = CupertinoColors.systemGrey;
  
  // 语义色
  static const success = CupertinoColors.systemGreen;
  static const warning = CupertinoColors.systemOrange;
  static const error = CupertinoColors.systemRed;
  
  // 背景色
  static const background = CupertinoColors.systemBackground;
  static const secondaryBackground = CupertinoColors.secondarySystemBackground;
  static const groupedBackground = CupertinoColors.systemGroupedBackground;
  
  // 文字色
  static const textPrimary = CupertinoColors.label;
  static const textSecondary = CupertinoColors.secondaryLabel;
  static const textTertiary = CupertinoColors.tertiaryLabel;
}
```

### 9.2 间距体系

```dart
class AppSpacing {
  static const xs = 4.0;
  static const sm = 8.0;
  static const md = 16.0;
  static const lg = 24.0;
  static const xl = 32.0;
  static const xxl = 48.0;
}
```

### 9.3 圆角体系

```dart
class AppRadius {
  static const sm = 8.0;
  static const md = 12.0;
  static const lg = 16.0;
  static const xl = 24.0;
}
```

---

## 10. 依赖包清单

### 10.1 pubspec.yaml 核心依赖

```yaml
dependencies:
  flutter:
    sdk: flutter
  cupertino_icons: ^1.0.6
  
  # 状态管理
  flutter_riverpod: ^2.4.9
  riverpod_annotation: ^2.3.3
  
  # 路由
  go_router: ^12.1.3
  
  # 本地存储
  hive_flutter: ^1.1.0
  path_provider: ^2.1.1
  
  # 数据模型
  freezed_annotation: ^2.4.1
  json_annotation: ^4.8.1
  
  # 图片处理
  image_picker: ^1.0.5
  flutter_image_compress: ^2.1.0
  
  # 定位
  geolocator: ^10.1.0
  geocoding: ^2.1.1
  
  # 通知
  flutter_local_notifications: ^16.2.0
  timezone: ^0.9.2
  
  # 权限
  permission_handler: ^11.1.0
  
  # 工具
  uuid: ^4.2.1
  intl: ^0.18.1
  url_launcher: ^6.2.2

dev_dependencies:
  flutter_test:
    sdk: flutter
  flutter_lints: ^3.0.1
  
  # 代码生成
  build_runner: ^2.4.7
  freezed: ^2.4.5
  json_serializable: ^6.7.1
  riverpod_generator: ^2.3.9
  hive_generator: ^2.0.1
```

---

## 11. 开发阶段规划

### 阶段一：基础框架（优先）
- [ ] 项目初始化 + 依赖安装
- [ ] Hive 存储配置
- [ ] 路由框架搭建
- [ ] 底部 Tab 导航
- [ ] 基础 UI 组件

### 阶段二：核心功能
- [ ] 物品 CRUD
- [ ] 记录功能（拍照+保存）
- [ ] 物品详情页（最后记录+时间线）
- [ ] 找回模式

### 阶段三：场景功能
- [ ] 场景列表 + 详情
- [ ] 场景连续记录
- [ ] 出门检查

### 阶段四：轻提醒
- [ ] 意图池 CRUD
- [ ] 通知调度
- [ ] 轻提醒卡片
- [ ] 文案随机+去重

### 阶段五：完善
- [ ] Onboarding 引导
- [ ] 统计功能
- [ ] 设置页
- [ ] 性能优化

---

## 12. 注意事项

### 12.1 图片存储策略
- 原图压缩后存储（quality: 80）
- 生成缩略图用于列表展示
- 图片命名：`{itemId}_{timestamp}.jpg`
- 定期清理无引用图片

### 12.2 定位策略
- 定位为可选功能，用户可不授权
- 授权后自动获取，不授权也能正常记录
- 逆地理编码失败时只存坐标

### 12.3 通知策略
- 首次引导时不强制请求
- 在「顺手」功能首次使用时引导
- 用户可随时关闭

### 12.4 性能考量
- 列表使用懒加载
- 图片使用缓存
- Provider 合理拆分避免过度重建
